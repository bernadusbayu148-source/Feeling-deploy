
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feeling Family</title>

  <style>
    :root {
      --bg:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#6366f1;
      --accent2:#22d3ee;
      --border:#1f2937;
      --card:#0b1220;
      --thead:#0f172a;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(1000px 400px at 10% 0%, #111827 30%, #0b1020 70%), var(--bg);
      color: var(--text);
    }

    .container{ max-width:1000px; margin:40px auto; padding:0 16px; }

    header h1{
      margin:0 0 8px;
      font-weight:800;
      font-size:clamp(24px,4vw,36px);
      letter-spacing:-.02em;
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    header p{ margin:0 0 18px; color:var(--muted); }

    .controls{
      display:grid; grid-template-columns:1fr auto auto; gap:8px; margin-bottom:16px; align-items:center;
    }
    .controls input, .controls select, .controls button{
      background:var(--card); color:var(--text);
      border:1px solid var(--border); border-radius:8px; padding:10px 12px; outline:none;
    }
    .controls button{
      cursor:pointer; background:linear-gradient(90deg, #4f46e5, #06b6d4);
      border:none; font-weight:600;
    }

    /* ====== PODIUM ====== */
    .podium {
      margin: 12px 0 20px;
      padding: 16px;
      border-radius: 16px;
      background: radial-gradient(1200px 400px at 50% -20%, #0d152b 20%, #0b1220 60%);
      border: 1px solid var(--border);
    }
    .podium-wrap {
      display: grid;
      grid-template-columns: 1fr 1.2fr 1fr; /* 2-1-3 layout: juara 2 ‚Äì 1 ‚Äì 3 */
      gap: 14px;
      align-items: end;
    }
    .podium-card {
      position: relative;
      background: #0e172a;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
    }
    .podium-card .podium-avatar {
      width: 84px; height: 84px; margin: 0 auto 10px; border-radius: 12px;
      background: linear-gradient(135deg, #1e293b, #0ea5e9 60%, #22d3ee);
      border: 1px solid #243447;
    }
    .podium-card .podium-name { margin: 6px 0 2px; font-weight: 700; }
    .podium-card .podium-member { margin: 0 0 10px; color: var(--muted); font-size: 0.95rem; }
    .podium-card .podium-trophy {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px;
      background: #0b1220; border: 1px solid var(--border);
    }
    .trophy-icon { font-size: 1.1rem; }

    .podium-card.first {
      transform: translateY(-8px);
      background: #0b1220;
      border: 1px solid #334155;
    }
    .podium-card.first .podium-avatar {
      width: 96px; height: 96px;
      background: linear-gradient(135deg, #1e293b, #f59e0b 60%, #f97316);
    }
    .podium-card.first .podium-badge {
      position: absolute; top: -10px; right: -10px;
      background: linear-gradient(90deg,#f59e0b,#f97316);
      color: #0b1220; font-weight: 800; padding: 8px 12px; border-radius: 999px;
      border: 1px solid #a16207;
    }
    .podium-card.second .podium-avatar {
      background: linear-gradient(135deg, #1e293b, #9ca3af 60%, #d1d5db);
    }
    .podium-card.third .podium-avatar {
      background: linear-gradient(135deg, #1e293b, #a855f7 60%, #c084fc);
    }
    .podium-meta {
      margin-top: 10px;
      color: var(--muted);
      font-size: 0.95rem;
      text-align: center;
    }
    @media (max-width: 900px) {
      .podium-wrap { grid-template-columns: 1fr; }
      .podium-card.first { transform: none; }
    }

    /* ====== TABEL ====== */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; font-weight:700; padding:12px 14px;
      background:var(--thead); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:1;
    }
    tbody td{ padding:12px 14px; border-bottom:1px solid var(--border); }
    tbody tr:nth-child(odd){ background:rgba(255,255,255,.02); }

    .rank-badge{
      display:inline-block; min-width:36px; text-align:center;
      padding:6px 10px; border-radius:999px; font-weight:700;
      color:#0b1220; background:#f59e0b;
    }
    .mono{ font-variant-numeric:tabular-nums; font-feature-settings:"tnum"; }
    .footer{ color:var(--muted); font-size:12px; padding:12px; text-align:right; }
    .empty{ padding:24px; text-align:center; color:var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Feeling Leaderboard</h1>
      <p>Data diambil dari Google Sheets (kolom: <strong>No Member</strong>, <strong>Nama</strong>, <strong>Point</strong>).</p>
    </header>

    <!-- ====== PODIUM 3 TERATAS ====== -->
    <section class="podium" aria-label="Klasemen 3 teratas">
      <div class="podium-wrap">
        <!-- Juara 2 -->
        <article class="podium-card second">
          <div class="podium-avatar" aria-hidden="true"></div>
          <h3 class="podium-name" id="podium2-name">‚Äî</h3>
          <p class="podium-member" id="podium2-member">‚Äî</p>
          <div class="podium-trophy">
            <span class="trophy-icon">üèÜ</span> <span id="podium2-point">0</span> poin
          </div>
        </article>

        <!-- Juara 1 -->
        <article class="podium-card first">
          <div class="podium-avatar" aria-hidden="true"></div>
          <h3 class="podium-name" id="podium1-name">‚Äî</h3>
          <p class="podium-member" id="podium1-member">‚Äî</p>
          <div class="podium-trophy">
            <span class="trophy-icon">üèÜ</span> <span id="podium1-point">0</span> poin
          </div>
          <div class="podium-badge">#1</div>
        </article>

        <!-- Juara 3 -->
        <article class="podium-card third">
          <div class="podium-avatar" aria-hidden="true"></div>
          <h3 class="podium-name" id="podium3-name">‚Äî</h3>
          <p class="podium-member" id="podium3-member">‚Äî</p>
          <div class="podium-trophy">
            <span class="trophy-icon">üèÜ</span> <span id="podium3-point">0</span> poin
          </div>
        </article>
      </div>
      <div class="podium-meta" id="podiumMeta" aria-live="polite"></div>
    </section>

    <!-- ====== KONTROL ====== -->
    <div class="controls" role="region" aria-label="Filter dan aksi">
      <input id="searchBox" type="search" placeholder="Cari nama atau No Member‚Ä¶" aria-label="Cari" />
      <select id="limitSelect" aria-label="Tampilkan">
        <option value="10" selected>Top 10</option>
        <option value="25">Top 25</option>
        <option value="50">Top 50</option>
        <option value="0">Semua</option>
      </select>
      <button id="refreshBtn" aria-label="Muat ulang data">Muat Ulang</button>
    </div>

    <!-- ====== TABEL LEADERBOARD ====== -->
    <div class="card" role="region" aria-label="Tabel leaderboard">
      <table id="board">
        <thead>
          <tr>
            <th style="width:90px">Peringkat</th>
            <th style="width:140px">No Member</th>
            <th>Nama</th>
            <th style="width:140px">Point</th>
          </tr>
        </thead>
        <tbody id="boardBody">
          <tr><td colspan="4" class="empty">Memuat data‚Ä¶</td></tr>
        </tbody>
      </table>
      <div class="footer" id="meta" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // ===== KONFIGURASI: Sheet kamu =====
    const SHEET_ID = "1UBrdYls_Ed0GIXCSPghK9C3du5dEhbdx";
    const GID      = "371192175";
    const HEADERS_EXPECT = ["No Member","Nama","Point"];

    // Endpoints
    const GVIZ_URL = (id,gid)=>`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&gid=${gid}`;
    const CSV_URL  = (id,gid)=>`https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;

    // State
    const state = { rows: [], filtered: [], limit: 10, query: "", rankMap: {} };

    const el = {
      body: document.getElementById("boardBody"),
      meta: document.getElementById("meta"),
      search: document.getElementById("searchBox"),
      limit: document.getElementById("limitSelect"),
      refresh: document.getElementById("refreshBtn"),
    };

    // ===== Fetch main =====
    async function fetchSheet(){
      el.body.innerHTML = `<tr><td colspan="4" class="empty">Memuat data‚Ä¶</td></tr>`;

      // Coba GVIZ
      if (await tryFetchGviz()) return;
      // Fallback CSV
      if (await tryFetchCsv()) return;

      el.body.innerHTML = `<tr><td colspan="4" class="empty">
        Gagal memuat data. Pastikan Sheet dibagikan publik dan sudah <b>Publish to the web</b>.
      </td></tr>`;
      el.meta.textContent = `Fetch gagal ‚Ä¢ ${new Date().toLocaleString("id-ID")}`;
    }

    async function tryFetchGviz(){
      try{
        const res = await fetch(GVIZ_URL(SHEET_ID, GID), { cache: "no-store" });
        const text = await res.text();
        const jsonStr = text.replace(/^[^(]+\(/,"").replace(/\)\s*;?\s*$/,"");
        const payload = JSON.parse(jsonStr);
        if (!payload.table) throw new Error("payload.table kosong");

        const headers = payload.table.cols.map(c => (c.label || "").trim());
        const rows = payload.table.rows.map(r => {
          const c = r.c || []; const o = {};
          headers.forEach((label,i)=>{ o[label] = c[i]?.v ?? ""; });
          return o;
        });

        applyAndRender(rows, headers, "Google Visualization (JSON)");
        return true;
      }catch(e){ console.warn("GVIZ gagal:", e); return false; }
    }

    async function tryFetchCsv(){
      try{
        const res = await fetch(CSV_URL(SHEET_ID, GID), { cache: "no-store" });
        const csv = await res.text();
        const { headers, rows } = parseCsv(csv);
        applyAndRender(rows, headers, "CSV export");
        return true;
      }catch(e){ console.warn("CSV gagal:", e); return false; }
    }

    function parseCsv(text){
      const lines = text.trim().split(/\r?\n/);
      const headers = splitCsvLine(lines[0]).map(h=>h.trim());
      const rows = lines.slice(1).map(line=>{
        const cols = splitCsvLine(line);
        const o={}; headers.forEach((h,i)=>{ o[h]=(cols[i]??"").trim(); });
        return o;
      });
      return { headers, rows };
    }
    function splitCsvLine(line){
      const out=[]; let cur="", q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch=='"'){ if(q && line[i+1]=='"'){cur+='"'; i++;} else { q=!q; } }
        else if(ch==',' && !q){ out.push(cur); cur=""; }
        else { cur+=ch; }
      }
      out.push(cur); return out;
    }

    function normalizeHeaderMap(headers, expected){
      const lower=headers.map(h=>h.toLowerCase()); const map={};
      expected.forEach(exp=>{ const idx=lower.indexOf(exp.toLowerCase()); if(idx>=0) map[exp]=headers[idx]; });
      return map;
    }

    // ===== Apply & Render with GLOBAL RANK =====
    function applyAndRender(rows, headers, source){
      const map = normalizeHeaderMap(headers, HEADERS_EXPECT);

      // Normalisasi data ke kolom yang kita pakai
      const data = rows.map(r=>({
        "No Member": r[map["No Member"]] ?? r["No Member"] ?? "",
        "Nama":      r[map["Nama"]]      ?? r["Nama"]      ?? "",
        "Point":     r[map["Point"]]     ?? r["Point"]     ?? 0
      }));

      // Sortir desc berdasarkan Point
      data.sort((a,b)=>Number(b["Point"])-Number(a["Point"]));

      // Peta rank global (No Member -> rank 1-based)
      const rankMap = {};
      data.forEach((row, i) => {
        const key = String(row["No Member"] ?? "").trim();
        if (key) rankMap[key] = i + 1;
      });

      state.rows = data;
      state.rankMap = rankMap;

      // Render podium 3 teratas
      renderPodium(state.rows);

      applyFilter();
      render();
      el.meta.textContent = `Sumber: ${source} ‚Ä¢ ${state.filtered.length} baris ‚Ä¢ ${new Date().toLocaleString("id-ID")}`;
    }

    function applyFilter(){
      const q = state.query.trim().toLowerCase();
      state.filtered = !q
        ? [...state.rows]
        : state.rows.filter(r =>
            String(r["No Member"]).toLowerCase().includes(q) ||
            String(r["Nama"]).toLowerCase().includes(q)
          );
    }

    function rankBadge(rank){
      const styles=[
        "background:linear-gradient(90deg,#f59e0b,#f97316);color:#0b1220;", // 1
        "background:linear-gradient(90deg,#9ca3af,#d1d5db);color:#0b1220;", // 2
        "background:linear-gradient(90deg,#c084fc,#a855f7);color:#0b1220;"  // 3
      ];
      const style=styles[rank-1]||"background:#374151;color:#e5e7eb;";
      return `<span class="rank-badge" style="${style}">${rank}</span>`;
    }

    function render(){
      // Tampilkan tabel mulai peringkat #4 (hindari duplikat podium)
      const startIndex = Math.min(3, state.filtered.length);
      const limit = state.limit===0 ? state.filtered.length - startIndex : state.limit;
      const slice = state.filtered.slice(startIndex, startIndex + limit);

      if (slice.length===0){
        el.body.innerHTML = `<tr><td colspan="4" class="empty">Tidak ada data.</td></tr>`;
        return;
      }

      const rowsHtml = slice.map((r) => {
        const key = String(r["No Member"] ?? "").trim();
        const rank = state.rankMap[key] ?? "-"; // gunakan peringkat global
        const point = Number(r["Point"] ?? 0).toLocaleString("id-ID");
        return `
          <tr>
            <td>${rankBadge(rank)}</td>
            <td class="mono">${r["No Member"] ?? ""}</td>
            <td>${r["Nama"] ?? ""}</td>
            <td class="mono"><b>${point}</b></td>
          </tr>
        `;
      }).join("");

      el.body.innerHTML = rowsHtml;
    }

    function renderPodium(sortedRows){
      const top3 = (sortedRows || state.rows).slice(0, 3);
      const p1 = top3[0] || { "Nama":"‚Äî", "No Member":"‚Äî", "Point":0 };
      const p2 = top3[1] || { "Nama":"‚Äî", "No Member":"‚Äî", "Point":0 };
      const p3 = top3[2] || { "Nama":"‚Äî", "No Member":"‚Äî", "Point":0 };

      const set = (id, text) => { const e = document.getElementById(id); if (e) e.textContent = text; };

      set("podium1-name",   String(p1["Nama"]));
      set("podium1-member", String(p1["No Member"]));
      set("podium1-point",  Number(p1["Point"]||0).toLocaleString("id-ID"));

      set("podium2-name",   String(p2["Nama"]));
      set("podium2-member", String(p2["No Member"]));
      set("podium2-point",  Number(p2["Point"]||0).toLocaleString("id-ID"));

      set("podium3-name",   String(p3["Nama"]));
      set("podium3-member", String(p3["No Member"]));
      set("podium3-point",  Number(p3["Point"]||0).toLocaleString("id-ID"));

      const meta = document.getElementById("podiumMeta");
      if (meta) meta.textContent = `Teratas saat ini ‚Ä¢ diperbarui ${new Date().toLocaleString("id-ID")}`;
    }

    // Events
    el.search.addEventListener("input",(e)=>{ state.query=e.target.value; applyFilter(); render(); });
    el.limit.addEventListener("change",(e)=>{ state.limit=Number(e.target.value); render(); });
    el.refresh.addEventListener("click",()=>{ fetchSheet(); });

    // Init
    fetchSheet();
  </script>
</body>
